<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hour Logger</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { --pad:16px; --bg:#0b0c0f; --card:#111319; --muted:#9aa3b2; --text:#e8ebf0; --stroke:#1c2030;
            --pill:#151823; --glow:0 0 32px rgba(91,140,255,.08); --accent:#5b8cff; --danger:#ff7a7a; }
    [data-theme="light"] { --bg:#f7f7fb; --card:#ffffff; --muted:#667084; --text:#101828; --stroke:#e5e7eb; --pill:#eef1f5; --glow:0 0 0 rgba(0,0,0,0); }
    [data-theme="dark"]  { --bg:#0b0c0f; --card:#111319; --muted:#9aa3b2; --text:#e8ebf0; --stroke:#1c2030; --pill:#151823; --glow:0 0 32px rgba(91,140,255,.08); }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);position:relative;overflow-x:hidden}
    #fxCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;filter:blur(10px)}
    .fx-top{position:relative;z-index:1;width:100%;margin:0 auto}

    .topbar{position:sticky;top:0;display:flex;gap:10px;align-items:center;padding:calc(10px + env(safe-area-inset-top, 0px)) var(--pad) 10px var(--pad);background:#0f1118aa;border-bottom:1px solid var(--stroke);backdrop-filter:saturate(180%) blur(8px);z-index:10}
    .title{font-weight:800; font-size:18px; text-align:center; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .btn{border:1px solid var(--stroke);background:#181b24;color:var(--text);border-radius:12px;padding:10px 14px;box-shadow:var(--glow);touch-action:manipulation}
    .btn.small{padding:8px 10px;font-size:12px;border-radius:10px}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .icon-btn{border:1px solid var(--stroke);background:#181b24;border-radius:12px;padding:10px;display:grid;place-items:center; width:40px; height:40px}

    .menu-dd{ position:absolute; top:56px; right:10px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:8px; display:none; box-shadow:0 24px 80px #0006 }
    .menu-dd.show{ display:block; }
    .menu-dd button{ display:block; width:100%; margin:4px 0; }

    .view{display:none;padding:calc(12px) var(--pad);position:relative;z-index:1}
    .view.active{display:block;animation:fade .25s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .hero{min-height:92px;border:1px solid var(--stroke);border-radius:18px;display:grid;place-items:center;background:radial-gradient(120% 120% at 10% 0%,rgba(91,140,255,.14),transparent 60%),radial-gradient(120% 120% at 90% 100%,rgba(192,132,252,.16),transparent 60%),var(--card);box-shadow:var(--glow)}
    .cards{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px;display:flex;gap:10px;align-items:center;box-shadow:var(--glow)}
    .card h3{margin:0;font-size:15px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border:1px solid var(--stroke);border-radius:999px;font-size:12px;color:var(--muted);background:var(--pill);box-shadow:var(--glow)}

    .week-card{ background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:10px; box-shadow:var(--glow); }
    .week-head{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; }
    .week-title{ font-weight:800; font-size:18px; }
    .week-nav{ display:flex; gap:6px; }
    .week-strip{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(120px,1fr);gap:10px;overflow-x:auto;scroll-snap-type:x mandatory;padding:8px 2px 8px}
    .day-wrap{display:grid;grid-template-rows:auto auto;gap:6px;min-width:120px;max-width:160px}
    .fill-btn{border:1px dashed var(--stroke);background:#0f1118;color:var(--muted);border-radius:10px;padding:8px 10px;font-size:12px;text-align:center}
    .fill-btn.active{border-style:solid;color:var(--text);}
    .day{position:relative;background:var(--card);border:1px solid var(--stroke);border-radius:14px;height:140px;overflow:hidden;scroll-snap-align:start;box-shadow:var(--glow)}
    .day.today{outline:2px solid var(--accent);outline-offset:-2px}
    .day .n{position:absolute;top:8px;left:10px;font-size:11px;font-weight:700;z-index:2;text-shadow:0 2px 6px #0008}
    .day .h{position:absolute;bottom:8px;right:10px;font-weight:700;font-size:11px;z-index:2;text-shadow:0 2px 6px #0008}
    .day .pct{position:absolute;bottom:8px;left:10px;font-weight:700;font-size:11px;z-index:2;opacity:.9;text-shadow:0 2px 6px #0008}
    .day canvas{ position:absolute; inset:0; width:100%; height:100%; z-index:0; pointer-events:none }

    .cal-footer{display:flex;gap:8px;flex-wrap:wrap;padding-top:8px;border-top:1px solid var(--stroke);margin-top:6px;font-size:12px}

    /* Focus bubble + details */
    .focus-layer{position:fixed;inset:0;display:none;z-index:50}
    .focus-layer.active{display:block}
    .backdrop{position:absolute;inset:0;background:#0007;backdrop-filter:blur(10px) saturate(120%)}
    .bubble-date{ position: fixed; top: calc(env(safe-area-inset-top, 0px) + 10px); left: 0; right: 0; text-align:center; font-weight:800; z-index:52 }
    .bubble{position:fixed;border-radius:16px;background:radial-gradient(120% 140% at 20% 10%,rgba(255,255,255,.06),transparent 60%),var(--card);border:1px solid var(--stroke);box-shadow:0 30px 100px #0006,0 0 60px rgba(91,140,255,.15);overflow:hidden;animation:gel .5s cubic-bezier(.2,.8,.2,1) both; z-index:52 }
    @keyframes gel{0%{filter:saturate(.9) blur(.35px)}40%{filter:saturate(1.05) blur(.2px)}100%{filter:saturate(1) blur(0)}}
    .bubble canvas{ position:absolute; inset:0; width:100%; height:100%; }
    .options{position:fixed; display:grid; gap:6px; padding:8px 14px; left: 0; right: 0; z-index:53 }
    .opt-btn{border:1px solid var(--stroke);background:#141824;color:var(--text);border-radius:12px;padding:10px 12px;box-shadow:var(--glow);opacity:0;transform:translateY(8px);animation:pop .35s ease forwards;font-size:14px}
    .opt-btn:nth-child(1){animation-delay:.12s}.opt-btn:nth-child(2){animation-delay:.18s}.opt-btn:nth-child(3){animation-delay:.24s}
    @keyframes pop{to{opacity:1;transform:none}}
    .details{ position:fixed; left:16px; right:16px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:10px; box-shadow:var(--glow); z-index:53; font-size:13px }
    .details h4{ margin:0 0 6px 0; font-size:14px }
    .row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:space-between; }

    /* Logger inputs */
    input[type="time"], input[type="date"], input[type="text"], input[type="number"]{ width:100%; border:1px solid var(--stroke); background:#0f1118; color:var(--text); border-radius:10px; padding:10px; font-size:15px; box-shadow:var(--glow) }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}

    /* Update banner + version */
    .update-banner{ position: fixed; left: 12px; right:12px; bottom: calc(env(safe-area-inset-bottom,0px) + 12px); background:#0f1a2a; color:#cbe0ff; border:1px solid #163458; border-radius:12px; padding:10px; display:none; align-items:center; justify-content:space-between; gap:8px; z-index:60; box-shadow:0 16px 60px #0008 }
    .update-banner.show{ display:flex }
    .version{ text-align:center; color:var(--muted); font-size:11px; margin:12px 0 6px }
    .page-wrap{ width:100%; margin: 0 auto; display: grid; gap: 12px; }
    .view{ padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 120px); }
    .card.actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center }

    /* Logger full centering */
    #view-logger .card{ display:grid; justify-items:center; text-align:center }
    #view-logger .card > *{ width:100% }
    #view-logger .row{ justify-content:center }
    #view-logger .actions{ justify-content:center }

    .line-stats{ display:flex; gap:8px; flex-wrap:wrap; }
    .version.version-menu{ position: fixed; left: 0; right: 0; bottom: calc(env(safe-area-inset-bottom, 0px) + 8px); text-align:center; z-index: 5; }

    @media (max-width:420px){
      .btn{padding:9px 12px}
      .week-strip{grid-auto-columns:minmax(112px,1fr)}
      .day{height:128px}
      .details{left:12px; right:12px}
    }

    .toast-wrap{ position:fixed; left:0; right:0; bottom:calc(env(safe-area-inset-bottom,0px) + 18px); display:grid; place-items:center; z-index:80; pointer-events:none }
    .toast{ background:#101826; color:#e8f0ff; border:1px solid #1d2a45; padding:10px 14px; border-radius:12px; box-shadow:0 10px 40px #0008; opacity:0; transform:translateY(10px); transition:.22s ease; font-size:13px; pointer-events:auto }
    .toast.show{ opacity:1; transform:none }

    /* Confine scroll horizontally to days strip only */
    html, body, .view, .page-wrap{ overflow-x: hidden; }
    .week-card{ overflow: hidden; }
    .week-strip{ overflow-x: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; }

    /* Holiday overlays */
    .day .holiday{
      position:absolute; inset:0; display:grid; place-items:center;
      font-size:48px; opacity:.98; z-index:1; pointer-events:none;
      text-shadow: 0 2px 8px rgba(0,0,0,.45);
    }
    .holiday-bubble{
      position:absolute; inset:0; display:none; place-items:center;
      font-size:110px; opacity:.98; z-index:2; pointer-events:none;
      text-shadow: 0 8px 24px rgba(0,0,0,.5);
    }
    .holiday-bubble.show{ display:grid; }

    /* Breaks layout */
    #breaksPane{ width:100%; max-height:300px; overflow:auto; }
    .break-item{ display:grid; gap:8px; width:100%; margin:10px 0; }
    .break-item .bi-name-block input{ font-size:14px; padding:10px }
    .break-item .bi-times{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    .break-item .bi-times input{ width:100%; text-align:center; font-size:14px; padding:10px }
    .break-item .bi-remove{ width:100%; padding:10px 12px; }
    @media (max-width:420px){
      .break-item .bi-times{ gap:6px }
      .break-item .bi-name-block input, .break-item .bi-times input{ font-size:13px; padding:9px }
    }
    @media (max-width:360px){
      .break-item .bi-times{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="toast-wrap"><div id="toast" class="toast">Saved</div></div>
  <canvas id="fxCanvas"></canvas>

  <div class="topbar fx-top">
    <button class="icon-btn" id="btnBack" aria-label="Back">◀︎</button>
    <div class="title">Hour Logger</div>
    <button class="icon-btn" id="btnMenu" aria-label="Menu">☰</button>
    <div class="menu-dd" id="menuDD">
      <button class="btn small" id="mLight">Light</button>
      <button class="btn small" id="mDark">Dark</button>
      <button class="btn small" id="mSync">Cloud sync…</button>
    </div>
  </div>

  <!-- MENU -->
  <section id="view-menu" class="view active fx-top"><div class="page-wrap">
    <div class="hero"><h1>Track your day</h1></div>
    <div class="cards">
      <div class="card">
        <div style="flex:1"><h3>Start logging</h3></div>
        <button class="btn primary" id="goLogger">Open</button>
      </div>
      <div class="card">
        <div style="flex:1"><h3>Calendar</h3></div>
        <button class="btn" id="goCalendar">Open</button>
      </div>
      <div class="line-stats"><span class="pill" id="pillWeek">Weekly hours: 0h 00m</span><span class="pill" id="pillBank">Overtime bank: 0h 00m</span></div>
    </div>
    <div class="version version-menu">Hour Logger 53</div>
  </section>

  <!-- Cloud Sync Panel -->
  <div id="syncPanel" style="display:none; position:fixed; inset:0; z-index:70;">
    <div id="syncBackdrop" style="position:absolute; inset:0; background:#0007; backdrop-filter:blur(10px)"></div>
    <div style="position:fixed; left:16px; right:16px; top:calc(env(safe-area-inset-top,0px) + 64px); background:var(--card); border:1px solid var(--stroke); border-radius:14px; padding:14px; box-shadow:0 24px 80px #0008;">
      <div style="font-weight:800; margin-bottom:8px;">Cloud sync (GitHub)</div>
      <div style="display:grid; gap:8px;">
        <input id="ghOwner" type="text" placeholder="GitHub owner (username/org)" />
        <input id="ghRepo" type="text" placeholder="Repository name" />
        <input id="ghBranch" type="text" placeholder="Branch (main)" />
        <input id="ghPath" type="text" placeholder="File path (e.g., data/hourlogger-data.json)" />
        <input id="ghToken" type="password" placeholder="Personal Access Token (repo: read/write)"/>
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
          <button class="btn small" id="ghLoad">Load from GitHub</button>
          <button class="btn small primary" id="ghSave">Save to GitHub</button>
        </div>
        <p style="font-size:12px; color:var(--muted); margin:4px 0 0">Token is stored only on this device. The JSON stays in GitHub.</p>
      </div>
    </div>
  </div>

  <!-- CALENDAR -->
  <section id="view-calendar" class="view fx-top"><div class="page-wrap">
    <div class="week-card">
      <div class="week-head">
        <div class="week-title" id="wTitle">—</div>
        <div class="week-nav">
          <button class="btn small" id="wPrev">◀︎</button>
          <button class="btn small" id="wToday">Today</button>
          <button class="btn small" id="wNext">▶︎</button>
        </div>
      </div>
      <div id="weekStrip" class="week-strip"></div>
      <div class="cal-footer" id="calFooter"></div>
    </div>
    <div class="version">Hour Logger 53</div>
  </section>

  <!-- LOGGER -->
  <section id="view-logger" class="view fx-top"><div class="page-wrap">
    <div class="card">
      <label>Date</label>
      <input type="date" id="logDate" />
      <div style="margin-top:8px">
        <label style="display:flex;align-items:center;gap:8px;">
          <input type="checkbox" id="holidayFlag" />
          <span>Public holiday (full day)</span>
        </label>
      </div>
    </div>
    <div class="card">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label><b>Start</b></label><input type="time" id="startTime"/><button class="btn small" id="btnStartNow" style="margin-top:8px;width:100%">Start now</button></div>
        <div><label><b>Stop</b></label><input type="time" id="stopTime"/><button class="btn small" id="btnStopNow" style="margin-top:8px;width:100%">Stop now</button></div>
        <div style="grid-column:1/-1;display:grid;gap:8px">
          <button class="btn small" id="btnAddBreak">Add break</button>
          <div id="breaksPane" style="width:100%;max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </div>
    <div class="card actions">
      <button class="btn primary" id="btnSave">Save day</button>
      <button class="btn" id="btnResetWork" style="white-space:nowrap">Reset this day</button>
    </div>
    <div class="version">Hour Logger 53</div>
  </section>

  <!-- Focus bubble -->
  <div id="focusLayer" class="focus-layer">
    <div class="backdrop" id="focusBackdrop"></div>
    <div class="bubble-date" id="bubbleDate">—</div>
    <div class="bubble" id="bubble"><canvas id="bubbleCanvas"></canvas><div id="bubbleHoliday" class="holiday-bubble">🏖️</div></div>
    <div class="options" id="bubbleOptions">
      <button class="opt-btn" id="optEditLog">Edit logging</button>
      <button class="opt-btn" id="optFillMissing">Fill missing time</button>
      <button class="opt-btn" id="optResetDay">Reset this day</button>
    </div>
    <div class="details" id="bubbleDetails">
      <h4>Details</h4>
      <div class="row"><span>Breaks</span><strong id="dBreaks">—</strong></div>
      <div class="row"><span>Worked</span><strong id="dWorked">0h 00m</strong></div>
      <div class="row"><span>Comp used</span><strong id="dCompUsed">0h 00m</strong></div>
      <div class="row"><span>Overtime</span><strong id="dOver">0h 00m</strong></div>
    </div>
  </div>

  <!-- Update banner -->
  <div id="updateBanner" class="update-banner">
    <span>New version available — Refresh</span>
    <button id="btnRefresh" class="btn small primary">Refresh</button>
  </div>

  <script>
    const APP_VERSION = "53";

    // Toast
    const __toast = document.getElementById('toast');
    function toast(msg){
      if(!__toast) return;
      __toast.textContent = msg;
      __toast.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>__toast.classList.remove('show'), 1500);
    }

    // Theme
    const menuBtn = document.getElementById('btnMenu'), menuDD = document.getElementById('menuDD'), backBtn = document.getElementById('btnBack');
    const mLight = document.getElementById('mLight'), mDark = document.getElementById('mDark');
    const setTheme = t => { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('hourlogger.theme', t); };
    setTheme(localStorage.getItem('hourlogger.theme') || 'dark');
    menuBtn.addEventListener('click', ()=> menuDD.classList.toggle('show'));
    mLight.addEventListener('click', ()=>{ setTheme('light'); menuDD.classList.remove('show'); });
    mDark .addEventListener('click', ()=>{ setTheme('dark');  menuDD.classList.remove('show'); });

    // Constants & state
    const TARGET=504, STORE_KEY='hourlogger.data';

    // Load + migrate
    function loadState(){
      const raw = localStorage.getItem(STORE_KEY);
      if(raw){ try{ const o=JSON.parse(raw); if(o && typeof o==='object') return o; }catch(e){} }
      // migrate from hourlogger.N
      let best=null, bestVer=-1;
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i)||''; const m=/^hourlogger\.(\d+)$/.exec(k);
        if(m){ const v=parseInt(m[1],10);
          try{ const o=JSON.parse(localStorage.getItem(k)); if(o && typeof o==='object' && v>bestVer){ best=o; bestVer=v; } }catch(e){}
        }
      }
      if(best){ localStorage.setItem(STORE_KEY, JSON.stringify(best)); return best; }
      return { work:{}, comp:{} };
    }
    const state = loadState(); if(!state.work) state.work={}; if(!state.comp) state.comp={};

    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
      try{ document.dispatchEvent(new CustomEvent('hourlogger:saved')); }catch(_){}
      try{ if(window.hourloggerCloud && window.hourloggerCloud.auto && typeof window.hourloggerCloud.saveSilently==='function'){ window.hourloggerCloud.saveSilently(); } }catch(_){}
    }
    if(navigator.storage && navigator.storage.persist){ navigator.storage.persist(); }

    // Helpers
    const pad=n=>String(n).padStart(2,'0');
    const toDateStr=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const startOfWeekMon=d=>{const x=new Date(d);const wd=(x.getDay()+6)%7;x.setDate(x.getDate()-wd);x.setHours(0,0,0,0);return x};
    const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const monthNames=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const dows=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    const fmtHM=m=>`${Math.floor(Math.abs(m)/60)}h ${String(Math.abs(m)%60).padStart(2,'0')}m`;
    const fmtSignedHM=m=>(m<0?'-':'')+fmtHM(m);
    const workMins=ds=>state.work[ds]?.netMins||0;
    const compMins=ds=>state.comp[ds]?.mins||0;
    const isHoliday=ds=>!!state.work[ds]?.holiday;
    const dayBankDelta=ds=>{ if(isHoliday(ds)) return 0; const w=workMins(ds), c=compMins(ds); return Math.max(0, w - TARGET) - c; };
    const overtimeBank=()=>{ const dates=new Set([...Object.keys(state.work),...Object.keys(state.comp)]); let t=0; dates.forEach(ds=>t+=dayBankDelta(ds)); return t; };

    // Background FX (RGB glow particles)
    const fx=document.getElementById('fxCanvas'),ctxFX=fx.getContext('2d'); let DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1)),W=0,H=0,particles=[];
    function resizeFX(){W=fx.width=Math.floor(innerWidth*DPR);H=fx.height=Math.floor(innerHeight*DPR);fx.style.width=innerWidth+'px';fx.style.height=innerHeight+'px';}
    function rnd(a,b){return a+Math.random()*(b-a)}
    function initParticles(){ const count=12; particles=Array.from({length:count},()=>({x:rnd(0,W),y:rnd(0,H),r:rnd(70,140)*DPR,a:rnd(0,Math.PI*2),s:rnd(0.1,0.35),h:rnd(0,360)})); }
    function drawFX(){ ctxFX.clearRect(0,0,W,H); ctxFX.globalCompositeOperation='lighter'; for(const p of particles){ p.a+=0.002*p.s; p.x+=Math.cos(p.a)*0.25*DPR; p.y+=Math.sin(p.a)*0.25*DPR; p.h=(p.h+0.06)%360; const g=ctxFX.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r); g.addColorStop(0,`hsla(${p.h},90%,60%,.16)`); g.addColorStop(1,`hsla(${(p.h+60)%360},90%,50%,0)`); ctxFX.fillStyle=g; ctxFX.beginPath(); ctxFX.arc(p.x,p.y,p.r,0,Math.PI*2); ctxFX.fill(); } requestAnimationFrame(drawFX); }
    addEventListener('resize',()=>{resizeFX();initParticles();}); resizeFX(); initParticles(); drawFX();

    // Sand + water renderer (cal/day visuals)
    function SandWater(canvas, worked, compUsed, overtime){
      const ctx = canvas.getContext('2d');
      let raf=0, t=0, DPR=1, w=0, h=0;
      const bubblesBottom=[], bubblesTop=[];

      function size(){
        DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1));
        const cw = Math.max(1, canvas.clientWidth|0);
        const ch = Math.max(1, canvas.clientHeight|0);
        w = canvas.width  = Math.floor(cw * DPR);
        h = canvas.height = Math.floor(ch * DPR);
      }
      function spawn(arr, area, count){ for(let i=0;i<count;i++){ arr.push({ x: area.x + Math.random()*area.w, y: area.y + area.h + Math.random()*10, r: 1 + Math.random()*2, vy: -(0.15+Math.random()*0.35)*DPR, drift:(Math.random()*0.4-0.2)*DPR }); } }
      function noise(y){ return (Math.sin(y*0.07 + t*0.8) + Math.sin(y*0.03 + t*0.6 + 2))/2; }

      function draw(){
        t += 0.016;
        ctx.clearRect(0,0,w,h);
        const half = h*0.5;

        const sandH = Math.min(half, half * (worked / 504));
        const compH = Math.min(Math.max(0, half - sandH), half * (compUsed / 504));
        const overH = Math.min(half, half * (Math.max(0,overtime) / 504));

        if (sandH>0){
          const topY = h - sandH;
          const grd = ctx.createLinearGradient(0, topY, 0, h); grd.addColorStop(0,'#daca9b'); grd.addColorStop(1,'#b8965b');
          ctx.fillStyle = grd; ctx.fillRect(0, topY, w, h-topY);
          for(let i=0;i<Math.floor(w*h*0.00035);i++){ const nx=Math.random()*w, ny=topY+Math.random()*(h-topY); ctx.fillStyle=`rgba(120,100,60,${Math.random()*0.35})`; ctx.fillRect(nx,ny,1,1);}
          for(let i=0;i<Math.floor(w*h*0.00005);i++){ const nx=Math.random()*w, ny=topY+Math.random()*(h-topY); ctx.fillStyle='rgba(90,70,30,0.25)'; ctx.beginPath(); ctx.arc(nx,ny,Math.random()*1.6+0.4,0,Math.PI*2); ctx.fill(); }
          ctx.beginPath(); ctx.moveTo(0, topY);
          for(let x=0;x<=w;x+=3){ const y=topY - 3*DPR + noise(x)*3*DPR; ctx.lineTo(x,y); } ctx.lineTo(w, topY); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fill();
        }

        if (compH>0){
          const area={x:0,y:h - sandH - compH,w:w,h:compH}; const waveY=area.y + 6*DPR + Math.sin(t*1.8)*2*DPR;
          const grdW=ctx.createLinearGradient(0,area.y,0,area.y+area.h); grdW.addColorStop(0,'rgba(100,180,255,0.55)'); grdW.addColorStop(1,'rgba(30,90,180,0.7)');
          ctx.fillStyle=grdW; ctx.fillRect(area.x,area.y,area.w,area.h);
          if(bubblesBottom.length<28) spawn(bubblesBottom, area, 2);
          for(let i=bubblesBottom.length-1;i>=0;i--){ const b=bubblesBottom[i]; b.y+=b.vy; b.x+=Math.sin((t+i)*0.8)*0.2*DPR+b.drift; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); if(b.y<area.y+4*DPR) bubblesBottom.splice(i,1); }
          ctx.beginPath(); ctx.moveTo(0,waveY); for(let x=0;x<=w;x+=4){ const y=waveY + Math.sin(x*0.04 + t*2.2)*2*DPR + Math.sin(x*0.025 + t*1.7)*1.2*DPR; ctx.lineTo(x,y);} ctx.lineTo(w,area.y); ctx.lineTo(0,area.y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
        }

        if (overH>0){
          const area={x:0,y:half - overH,w:w,h:overH}; const waveY=area.y + 6*DPR + Math.sin(t*2.0)*2*DPR;
          const grdW2=ctx.createLinearGradient(0,area.y,0,area.y+area.h); grdW2.addColorStop(0,'rgba(120,200,255,0.55)'); grdW2.addColorStop(1,'rgba(10,70,160,0.75)');
          ctx.fillStyle=grdW2; ctx.fillRect(area.x,area.y,area.w,area.h);
          if(bubblesTop.length<20) spawn(bubblesTop, area, 1);
          for(let i=bubblesTop.length-1;i>=0;i--){ const b=bubblesTop[i]; b.y+=b.vy; b.x+=Math.sin((t+i)*1.1)*0.25*DPR+b.drift; ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.5)'; ctx.fill(); if(b.y<area.y+2*DPR) bubblesTop.splice(i,1); }
          ctx.beginPath(); ctx.moveTo(0,waveY); for(let x=0;x<=w;x+=4){ const y=waveY + Math.sin(x*0.05 + t*2.0)*2*DPR + Math.sin(x*0.03 + t*1.6)*1.2*DPR; ctx.lineTo(x,y);} ctx.lineTo(w,area.y); ctx.lineTo(0,area.y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.08)'; ctx.fill();
        }

        // midline
        const ctxLine = ctx; ctxLine.strokeStyle='rgba(255,255,255,0.06)'; ctxLine.lineWidth=1*DPR; ctxLine.beginPath(); ctxLine.moveTo(0,h*0.5); ctxLine.lineTo(w,h*0.5); ctxLine.stroke();

        raf = requestAnimationFrame(draw);
      }
      function start(){ cancel(); size(); raf = requestAnimationFrame(draw); }
      function cancel(){ if(raf) cancelAnimationFrame(raf); raf=0; }
      const ro = new ResizeObserver(()=>start()); ro.observe(canvas);
      requestAnimationFrame(start);
      return { cancel, start };
    }

    // Views
    const views={menu:document.getElementById('view-menu'),calendar:document.getElementById('view-calendar'),logger:document.getElementById('view-
